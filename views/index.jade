extends layout

block content
  #app
    if !loginUser
      section.signin
        .dialog
          form.ui-component(action="/login" method="post")
            div.userid.ui-block
              label.ui-component(id="username") ユーザーネーム
              input.ui-component(type="text" name="username" for="username" placeholder="username")
            div.password.ui-block
              label.ui-component パスワード
              input.ui-component(type="password" name="password" placeholder="password")
            div.ui-block
              button.ui-component(type="submit") ログイン
      section.about
        .container
          .head-component
            h1 About
              span このサービスについて
          .read 
            |このサービスは、会員専用のためご利用にはログインが必要です。
            |また、現在開発中のため、動作や見た目が変わります。
    else
      section.date
        .holder
          .block.today
            .ui-component(v-on:click="changeDate(0)") 本日
          .block.present
            .holder
              .nav.prev(v-on:click="changeDate(-1)") 
                i.fas.fa-chevron-left.fa-lg
              .text
                span.num {{currentDate.year}}
                span.unit 年
                span.num {{currentDate.month}}
                span.unit 月
                span.num {{currentDate.day}}
                span.unit 日
                span.unit (
                span.dayofweek {{currentDate.dayOfWeekString}}
                span.unit )
              .nav.next(v-on:click="changeDate(1)") 
                i.fas.fa-chevron-right.fa-lg
          .block.select
            i.fas.fa-calendar-alt.fa-2x
      section.office
        .container
          .office-list
            .box(v-for="office in offices", v-bind:key="office.officeId")
              .information
                .photo
                  img.responsive-img(v-bind:src="office.imgPath", v-on:load="showImg=true", v-bind:class="{hide: !showImg}")
                .name {{office.officename}}
              .data
                ul.space-list
                  li.space.clearfix(v-for="space in officeSpaceObject[office.officeId]", v-bind:key="space.spaceId")
                    .information.clearfix
                      .name {{space.spacename}}
                      .capacity
                        |最大
                        span {{space.capacity}}
                        |名
                    .reservation
                      .period(v-for="period in space.periods", v-bind:key="period.num")
                        .time {{period.periodname}}
                        a.status.available(v-if="period.availability", key="reserve-available", v-bind:href="'/reserve/space/' + space.spaceId + '/period/' + period.num + '/year/' + currentDate.year + '/month/' + currentDate.month + '/day/' + currentDate.day") &#9675;
                        .status.unavailable.nav-detail(v-else-if="period.isSelf", key="reserve-is-self", v-on:click="viewDetail(period)") 予約済
                        .status.unavailable(v-else, key="reserve-not-available") &#10005;
      transition
        .overlay(v-show="showModal", v-on:click.self="showModal=!showModal")
          .modal
            .panel
              .section.cancel
                  .message
                    h1 予約内容
                    .information
                      .office
                        .head 施設名
                        .body {{reservationData.officename}}
                      .space
                        .head 部屋
                        .body {{reservationData.spacename}}
                      .date
                        .head 日時
                        .body {{reservationData.year}}年 {{reservationData.month}}月 {{reservationData.day}}日({{reservationData.dayofweek}}) {{reservationData.periodname}}
                      .name
                        .head お名前
                        .body {{reservationData.guestname}}
                  .nav-holder
                    .btn-holder
                      .btn-close.ui-component(v-on:click="showModal=!showModal") 閉じる
                    .btn-holder
                      a.ui-component.confirm(v-bind:href="'/reserve/cancel/' + reservationData.reservationId") 予約をキャンセルする
            .close(v-on:click="showModal=!showModal")

block script
  script.
    'use strict';

    var app = new Vue({
      el: '#app',
      data: {
        currentDate: {},
        offices: [],
        officeSpaceObject: {},
        reservationData: {},
        showImg: false,
        showModal: false
      },
      mounted() {
        fetch('/dateOfCurrentDay')
          .then(response => response.json())
          .then((data) => {
            this.currentDate = data.currentDate;
            this.offices = data.offices;
            this.officeSpaceObject = data.officeSpaceObject;
          })
      },
      methods: {
        changeDate: function(direction) {
          var url = '/dateOfCurrentDay';
          if (direction !== 0) {
            var day = Number(this.currentDate.day) + direction;
            var parameter = '?year=' + this.currentDate.year + '&month=' + this.currentDate.month + '&day=' + day;
            url += parameter;
          }
          fetch(url)
            .then(response => response.json())
            .then((data) => {
              this.currentDate = data.currentDate;
              this.offices = data.offices;
              this.officeSpaceObject = data.officeSpaceObject;
            })
        },
        viewDetail: function(reservationData) {
          this.showModal=!this.showModal;
          this.reservationData = reservationData;
        }
      }
    })
